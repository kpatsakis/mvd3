static long hiddev_compat_ioctl(struct file *file, unsigned int cmd, unsigned long arg) return hiddev_ioctl ( file , cmd , ( unsigned long ) compat_ptr ( arg ) ) ; static long hiddev_ioctl(struct file *file, unsigned int cmd, unsigned long arg) struct hiddev_list * list = file -> private_data ; struct hiddev * hiddev = list -> hiddev ; struct hid_device * hid ; struct hiddev_report_info rinfo ; struct hiddev_field_info finfo ; struct hid_report * report ; void __user * user_arg = ( void __user * ) arg ; if ( ! hiddev -> exist )  hid = hiddev -> hid; switch ( cmd )  if ( copy_from_user ( & rinfo , user_arg , sizeof ( rinfo ) ) )  if ( rinfo . report_type == HID_REPORT_TYPE_OUTPUT )  report = hiddev_lookup_report ( hid , & rinfo ); static struct hid_report hiddev_lookup_report(struct hid_device *hid, struct hiddev_report_info *rinfo) unsigned int flags = rinfo -> report_id & ~HID_REPORT_ID_MASK ; unsigned int rid = rinfo -> report_id & HID_REPORT_ID_MASK ; struct hid_report_enum * report_enum ; struct hid_report * report ; struct list_head * list ; if ( rinfo -> report_type < HID_REPORT_TYPE_MIN || rinfo -> report_type > HID_REPORT_TYPE_MAX )  return NULL ; report_enum = hid -> report_enum + ( rinfo -> report_type - HID_REPORT_TYPE_MIN ); switch ( flags )  if ( list_empty ( & report_enum -> report_list ) )  return NULL ; list = report_enum -> report_list . next; report = list_entry ( list , struct hid_report , list ) rinfo -> report_id = report -> id; report = report_enum -> report_id_hash [ rid ]; if ( ! report )  return NULL ; list = report -> list . next; if ( list == & report_enum -> report_list )  return NULL ; report = list_entry ( list , struct hid_report , list ) rinfo -> report_id = report -> id; return NULL ; return report_enum -> report_id_hash [ rinfo -> report_id ] ; if ( copy_from_user ( & rinfo , user_arg , sizeof ( rinfo ) ) )  if ( rinfo . report_type == HID_REPORT_TYPE_INPUT )  report = hiddev_lookup_report ( hid , & rinfo ); static struct hid_report hiddev_lookup_report(struct hid_device *hid, struct hiddev_report_info *rinfo) unsigned int flags = rinfo -> report_id & ~HID_REPORT_ID_MASK ; unsigned int rid = rinfo -> report_id & HID_REPORT_ID_MASK ; struct hid_report_enum * report_enum ; struct hid_report * report ; struct list_head * list ; if ( rinfo -> report_type < HID_REPORT_TYPE_MIN || rinfo -> report_type > HID_REPORT_TYPE_MAX )  return NULL ; report_enum = hid -> report_enum + ( rinfo -> report_type - HID_REPORT_TYPE_MIN ); switch ( flags )  if ( list_empty ( & report_enum -> report_list ) )  return NULL ; list = report_enum -> report_list . next; report = list_entry ( list , struct hid_report , list ) rinfo -> report_id = report -> id; report = report_enum -> report_id_hash [ rid ]; if ( ! report )  return NULL ; list = report -> list . next; if ( list == & report_enum -> report_list )  return NULL ; report = list_entry ( list , struct hid_report , list ) rinfo -> report_id = report -> id; return NULL ; return report_enum -> report_id_hash [ rinfo -> report_id ] ; if ( copy_from_user ( & rinfo , user_arg , sizeof ( rinfo ) ) )  report = hiddev_lookup_report ( hid , & rinfo ); static struct hid_report hiddev_lookup_report(struct hid_device *hid, struct hiddev_report_info *rinfo) unsigned int flags = rinfo -> report_id & ~HID_REPORT_ID_MASK ; unsigned int rid = rinfo -> report_id & HID_REPORT_ID_MASK ; struct hid_report_enum * report_enum ; struct hid_report * report ; struct list_head * list ; if ( rinfo -> report_type < HID_REPORT_TYPE_MIN || rinfo -> report_type > HID_REPORT_TYPE_MAX )  return NULL ; report_enum = hid -> report_enum + ( rinfo -> report_type - HID_REPORT_TYPE_MIN ); switch ( flags )  if ( list_empty ( & report_enum -> report_list ) )  return NULL ; list = report_enum -> report_list . next; report = list_entry ( list , struct hid_report , list ) rinfo -> report_id = report -> id; report = report_enum -> report_id_hash [ rid ]; if ( ! report )  return NULL ; list = report -> list . next; if ( list == & report_enum -> report_list )  return NULL ; report = list_entry ( list , struct hid_report , list ) rinfo -> report_id = report -> id; return NULL ; return report_enum -> report_id_hash [ rinfo -> report_id ] ; if ( report == NULL )  rinfo . num_fields = report -> maxfield; if ( copy_from_user ( & finfo , user_arg , sizeof ( finfo ) ) )  rinfo . report_type = finfo . report_type; rinfo . report_id = finfo . report_id; report = hiddev_lookup_report ( hid , & rinfo ); static struct hid_report hiddev_lookup_report(struct hid_device *hid, struct hiddev_report_info *rinfo) unsigned int flags = rinfo -> report_id & ~HID_REPORT_ID_MASK ; unsigned int rid = rinfo -> report_id & HID_REPORT_ID_MASK ; struct hid_report_enum * report_enum ; struct hid_report * report ; struct list_head * list ; if ( rinfo -> report_type < HID_REPORT_TYPE_MIN || rinfo -> report_type > HID_REPORT_TYPE_MAX )  return NULL ; report_enum = hid -> report_enum + ( rinfo -> report_type - HID_REPORT_TYPE_MIN ); switch ( flags )  if ( list_empty ( & report_enum -> report_list ) )  return NULL ; list = report_enum -> report_list . next; report = list_entry ( list , struct hid_report , list ) rinfo -> report_id = report -> id; report = report_enum -> report_id_hash [ rid ]; if ( ! report )  return NULL ; list = report -> list . next; if ( list == & report_enum -> report_list )  return NULL ; report = list_entry ( list , struct hid_report , list ) rinfo -> report_id = report -> id; return NULL ; return report_enum -> report_id_hash [ rinfo -> report_id ] ; if ( report == NULL )  if ( finfo . field_index >= report -> maxfield )  memset ( & finfo , 0 , sizeof ( finfo ) ); finfo . report_type = rinfo . report_type; finfo . report_id = rinfo . report_id; finfo . field_index = field -> report_count - 1; finfo . maxusage = field -> maxusage; finfo . flags = field -> flags; finfo . physical = field -> physical; finfo . logical = field -> logical; finfo . application = field -> application; finfo . logical_minimum = field -> logical_minimum; finfo . logical_maximum = field -> logical_maximum; finfo . physical_minimum = field -> physical_minimum; finfo . physical_maximum = field -> physical_maximum; finfo . unit_exponent = field -> unit_exponent; finfo . unit = field -> unit; r = copy_to_user ( user_arg , & finfo , sizeof ( finfo ) ) ? - EFAULT : 0; return r ; 